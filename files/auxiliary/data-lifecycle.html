<!DOCTYPE html><html><head><meta charset="utf-8"><title>Data lifecycle - Auxiliary Docs | Factorio</title><link href="https://cdn.factorio.com/assets/fonts/titillium-web.css" rel="stylesheet"><link href="https://cdn.factorio.com/assets/fonts/roboto-mono.css" rel="stylesheet"><link href="../style.css?v=72ae9920" rel="stylesheet" type="text/css"><meta name="viewport" content="width=device-width"><link rel="shortcut icon" href="../static/favicon.png"><script src="../script.js?v=72ae9920"></script></head><body class="docs docs-wide"><div id="top" class="top-bar mb32"><div class="top-bar-inner"><div class="sites links flex flex-items-baseline" style="width: 100%"><span><a href="https://factorio.com" style="color: #7dcaed;">Factorio.com</a><span class="separator">|</span><a href="https://forums.factorio.com/" style="color: #7dcaed;">Forums</a><span class="separator">|</span><a href="https://wiki.factorio.com/" style="color: #7dcaed;">Wiki</a><span class="separator">|</span><a href="https://mods.factorio.com" style="color: #7dcaed;">Mod Portal</a><span class="separator">|</span><a href="../index.html" class="sites-current">API Docs</a></span><span style="margin-left: auto;"><a href="../index-prototype.html">Prototype</a><span class="separator">|</span><a href="../index-runtime.html">Runtime</a><span class="separator">|</span><a href="../index-auxiliary.html" class="sites-current">Auxiliary</a></span></div></div></div><div class="container"><div class="container-inner"><div id="auxiliary-page"></div> <h1 class="ml8 mr8" style="position: relative;"><a href="../index-auxiliary.html" style="color: #ffe6c0;">Factorio Auxiliary Docs</a><a href="/" class="version-link" style="color: #ffe6c0;"><span class="version-string">Version</span> 2.0.55 <img src="../static/collapse-symbol.png" class="collapse-icon"></a></h1><div id="docs-layout-panel" class="panel flex-column pb0 overflow-unset"><div class="flex flex-reverse docs-panes " style="margin-top: -12px;"><div class="docs-content flex flex-column"><div class="panel-inset breadcrumbs mb0 p4"><span class="breadcrumbs-text"><a href="../index-auxiliary.html">Home</a> / <a href="data-lifecycle.html">Data lifecycle</a></span><a id="page-width-button" class="button square-sm" style="float: right;">&gt;&lt;</a></div><div class="panel-inset-lighter" style="flex-grow: 1;"><h2 id="data-lifecycle">Data lifecycle<a class="ml8 link" href="#data-lifecycle"><img src="../static/link-symbol.png"></a></h2><p>Factorio allows mods to run their code at two distinct points: At <em>game startup</em>, and while a map is actively being played. These stages have different rules and constraints, which are explored separately below. Note that while mods run continuously during a gameplay session, the <em>save startup</em> phase is particularly relevant for a proper understanding of the data lifecycle.</p><p>A mod's files need to be structured in a specific way for the game to pick up on them. While each stage description below mentions which files it is looking for, the <a href="https://wiki.factorio.com/Tutorial:Mod_structure">wiki</a> has a general overview of what a mod's file structure should look like.</p><p>The game gives all active mods an order that takes into account their dependencies first and their internal names second. This order determines the load sequence of mods at game startup, as well as the order in which events are sent during runtime. Specifically, the depth of each mod's dependency chain is taken into account first, sorting the shorter ones to the front of the queue. For mods with identical chain depths, the <a href="https://en.wikipedia.org/wiki/Natural_sort_order">natural sort order</a> of their internal names then determines the definitive ordering.</p><p>Note that <a href="instrument.html">Instrument Mode</a> may be enabled for a single mod to inject code for mod development tools, which impacts the data lifecycle for that mod.</p><h3 id="game-startup">Game startup<a class="ml8 link" href="#game-startup"><img src="../static/link-symbol.png"></a></h3><p>When Factorio is launched, it proceeds to load all the prototypes and assets that it and any active mods require. Two parts of this process are relevant to mods: The <em>settings stage</em> and the <em>prototype stage</em>. They are very similar in structure, so the following instructions apply to both.</p><p>For either stage, a single shared Lua state is created that is used to run three specific files for every mod. First, each mod's "<code>stage</code>.lua" file is run according to the usual sequence, then each mod's "<code>stage</code>-updates.lua" is run, after which each mod's "<code>stage</code>-final-fixes.lua" is run. This way, every mod gets the chance to add new prototypes or modify existing ones. These consecutive 'rounds' allow a mod to influence other mods' prototypes without necessarily needing to rely on dependencies for load order. Changes to prototypes during either stage are tracked and a history of which mod has changed which prototype is recorded by the game.</p><p>During these stages, no actual game instance exists, and the standard Lua API is not available. Instead, several global Lua variables are provided. Most notably, a <code>data</code> table that collects all the prototypes that are being created. It expects a specific format for <a href="../prototypes.html">each kind of prototype</a>. Missing properties will either fall back to a default value or give an error that indicates what is missing. Extra properties that the game isn't looking for are ignored.</p><p>In addition to the <code>data</code> table, the game provides the <code>mods</code> table which contains a mapping of mod name to mod version for all enabled mods. It can be used to adjust a mod's functionality depending on which other mods are active alongside it.</p><p>After a stage's three 'rounds' have finished, the shared Lua state is discarded, meaning no variables or functions defined in it will carry over. Any properties the game wasn't looking for are discarded.</p><h4 id="settings-stage">Settings stage<a class="ml8 link" href="#settings-stage"><img src="../static/link-symbol.png"></a></h4><p><img src="../static/settings-stage.png" onclick="this.requestFullscreen()"></p><p>The settings stage runs through <code>settings.lua</code>, <code>settings-updates.lua</code> and <code>settings-final-fixes.lua</code> in the manner explained above, allowing mods to add all the mod setting prototypes they need. The format for these is documented on the <a href="https://wiki.factorio.com/Tutorial:Mod_settings">wiki</a>.</p><p>At the end of this stage, the settings prototypes are constructed and the player's settings are read from their "mods" directory's "mod-settings.dat" file.</p><h4 id="prototype-stage">Prototype stage<a class="ml8 link" href="#prototype-stage"><img src="../static/link-symbol.png"></a></h4><p><img src="../static/data-stage.png" onclick="this.requestFullscreen()"></p><p>The prototype (or <em>data</em>) stage runs through <code>data.lua</code>, <code>data-updates.lua</code> and <code>data-final-fixes.lua</code> in the manner explained above, allowing mods to add all the non-setting prototypes they need. The format for these is documented in the <a href="../index-prototype.html">prototype API docs</a>.</p><p>During the prototype stage, the game provides a special global <code>settings</code> variable which is populated with all the startup mod settings that were loaded at the end of the settings stage. Note that <code>settings</code> prototypes can no longer be modifed.</p><p>At the end of this stage, all prototypes are constructed and the game goes to the main menu.</p><h3 id="save-startup">Save startup<a class="ml8 link" href="#save-startup"><img src="../static/link-symbol.png"></a></h3><p>The control stage begins as soon as a player starts a new game or loads a save, and lasts for the duration of that save. It allows mods to continuously influence the state of a running game in a variety of ways. Note that prototypes can no longer be modified, and the global <code>data</code> variable is no longer accessible.</p><p>The control stage is documented in the <a href="../index-runtime.html">runtime docs</a>.</p><p>At the very start of the control stage, the game goes through a series of steps, each with their own purpose and rules, before a save is considered to be fully loaded and running. Note that at every step, each mod's code is run according to the usual sequence.</p><p><img src="../static/control-stage.png" onclick="this.requestFullscreen()"></p><p>This diagram shows the steps an individual mod goes through, including two points in time (indicated by the diamond-shaped nodes) where one of two paths is taken by a mod depending on certain conditions. Note that while not every mod necessarily goes through the same steps, any step is run for all appropriate mods before moving on to the next one. The numbering of the nodes in the diagram mirror the order of these steps.</p><p>The first fork depends on whether a mod is considered new to the save or not. A mod is considered new to the save either when the player starts a new save with the mod enabled, or when the mod is added to an existing game that it hasn't been a part of previously. Note that adding a <code>control.lua</code> file to an existing mod is treated as that mod being newly added. If the mod is new, its <code>on_init()</code> handler will first be run, after which any applicable migrations are run. Its <code>on_load()</code> handler will not be run. If a mod is not new however, any applicable migrations will be run, after which its <code>on_load()</code> handler will be run. Its <code>on_init()</code> handler will not be run.</p><p>The second fork depends on whether the mod configuration has changed. The configuration is considered to be different when the game version or any mod version changed, when any mod is added or removed, when a startup setting has changed, when any prototypes have been added or removed, or when a migration was applied. This is mod-agnostic, meaning the <code>on_configuration_changed()</code> handlers will either be run for every active mod, or for none of them.</p><p>Note that when downloading the save file to connect to a running multiplayer session, the answer to the diamond-shaped nodes will always be "No", and all migrations will have been applied previously. Because of this, effectively only steps 1 (<code>control.lua</code>) and 4 (<code>on_load()</code>) (marked yellow in the diagram) will run. They should be used to make sure the joining player's Lua state is identical to that of the existing players' state. This mostly means making sure event registrations are identical, especially if conditional registrations are used.</p><p>The following sections about the individual steps presuppose an understanding of <a href="storage.html">storage</a>. After all the relevant steps have been executed, the save is considered fully setup and running. Access to all API objects will be available in any event handler.</p><h4 id="[1]-">[1] <code>control.lua</code><a class="ml8 link" href="#[1]-"><img src="../static/link-symbol.png"></a></h4><p>During this step, each mod's <code>control.lua</code> file is loaded and executed in their own Lua state that will be owned by them for the remainder of the play session. It allows a mod to register for events using the <a href="../classes/LuaBootstrap.html">script</a> object, register remote interfaces with the <a href="../classes/LuaRemote.html">remote</a> object, or register custom commands with the <a href="../classes/LuaCommandProcessor.html">commands</a> object.</p><p>Access to the <a href="../classes/LuaGameScript.html">game</a> and <a href="../classes/LuaRendering.html">rendering</a> objects is not available as the game state can not be manipulated at this point. While each mod has their own <a href="storage.html">storage</a> table, it is not restored from the save file until just before <code>on_load</code>. It is discouraged to initialize <a href="storage.html">storage</a> during this step, as <code>on_init</code> should be used instead.</p><p>Since this step is run every time a save file is created or loaded, it is not necessary to restart the game for changes to the <code>control.lua</code> file to take effect. Restarting or reloading a save will re-run this step and pick up any modifications to the code.</p><h4 id="[2]-">[2] <code>on_init()</code><a class="ml8 link" href="#[2]-"><img src="../static/link-symbol.png"></a></h4><p>This step is only run when starting a new save game or for mods that are new to an existing one. During it, their <a href="../classes/LuaBootstrap.html#on_init">LuaBootstrap::on_init</a> handler is called to give the mod the chance to set up initial values that it will use for its lifetime. It has full access to the <a href="../classes/LuaGameScript.html">game</a> object and its <a href="storage.html">storage</a> table and can change anything about the game state that it deems appropriate.</p><p>Note that scenario scripts are treated like mods for this step. Also, no other events will be raised for a mod or scenario until it has finished this step.</p><h4 id="[3]-migrations">[3] Migrations<a class="ml8 link" href="#[3]-migrations"><img src="../static/link-symbol.png"></a></h4><p>During this step, the game automatically runs the <a href="migrations.html">migrations</a> that each mod includes and that haven't been applied to the save previously. To that end, saves will remember the file names of the migrations that have already been applied to it, and thus won't run any migration more than once.</p><p>Migrations are run in their mod's Lua state and have full access to the game state. If a mod doesn't have a <code>control.lua</code> file and thus no runtime Lua state, the game creates a temporary Lua environment to run the migrations in, which is discarded afterwards.</p><p>First, all JSON migrations are run which allow changing one prototype into another, typically when renaming them. Then, all Lua migrations are run, allowing mods to adjust the game state as necessary after recipes or technologies have changed.</p><p>Note that when connecting to a running multiplayer session, migrations will not be run, since they will already have done so when starting the multiplayer server. The save file a joining player downloads is thus already migrated.</p><h4 id="[4]-">[4] <code>on_load()</code><a class="ml8 link" href="#[4]-"><img src="../static/link-symbol.png"></a></h4><p>This step runs for every mod that has been a part of the save previously, including when loading a save to connect to a running multiplayer session. During it, the mod's <a href="../classes/LuaBootstrap.html#on_load">LuaBootstrap::on_load</a> handler is called. It gives the mod the opportunity to rectify potential differences in local state introduced by the save/load cycle. Doing anything other than the following three will lead to desyncs, breaking both multiplayer and replays. Access to the <a href="../classes/LuaGameScript.html">game</a> object is not available. The <a href="storage.html">storage</a> table can be accessed and is safe to read from, but not write to, as doing so will lead to an error.</p><p>The only legitimate uses of this step are these:</p><ul><li>Re-setup <a href="https://www.lua.org/pil/13.html">metatables</a> not registered with <a href="../classes/LuaBootstrap.html#register_metatable">LuaBootstrap::register_metatable</a>, as they are not persisted through the save/load cycle.</li><li>Re-setup conditional event handlers, meaning subscribing to an event only when some condition is met to save processing time.</li><li>Create local references to data stored in the <a href="storage.html">storage</a> table.</li></ul><p>For all other purposes, <a href="../classes/LuaBootstrap.html#on_init">LuaBootstrap::on_init</a>, <a href="../classes/LuaBootstrap.html#on_configuration_changed">LuaBootstrap::on_configuration_changed</a> or <a href="migrations.html">migrations</a> should be used instead.</p><p>Note that no other events will be raised for a mod until it has finished this step.</p><h4 id="[5]-">[5] <code>on_configuration_changed()</code><a class="ml8 link" href="#[5]-"><img src="../static/link-symbol.png"></a></h4><p>This step runs for all mods if the save's mod configuration has changed. The configuration is considered to be different when the game version or any mod version changed, when any mod was added or removed, when a startup setting has changed, when any prototypes have been added or removed, or when a migration was applied.</p><p>During it, their <a href="../classes/LuaBootstrap.html#on_configuration_changed">LuaBootstrap::on_configuration_changed</a> handler is called, allowing them to make changes or adjustments to their internal data structures. To that end, <a href="storage.html">storage</a> can be accessed and modified at will. Mods also have full access to the <a href="../classes/LuaGameScript.html">game</a> object, enabling any change to the game state that they deem appropriate.</p><p>Note that when connecting to a running multiplayer session, this event will not be called, since it will already have done so when starting the multiplayer server. The save file a joining player downloads is thus already up-to-date.</p> </div></div><div class="docs-sidebar mr12 flex-column fs0"><div class="panel-inset breadcrumbs mb0 p4"><span class="breadcrumbs-text"><a href="../defines.html" class="category-link" data-view="list-defines">Defines</a></span><a id="hide-sidebar-button" class="button square-sm" style="float: right;">|&lt;</a></div><div class="panel-inset mb0 fs0 p4 flex"><input id="ref-search" type="text" class="w100p" placeholder="Search..." spellcheck="false"></div><div id="docs-sidebar-list" class="panel-inset-lighter mt0 p2 docs-sidebar-list h100"><h2 class="ml8 mt8 mb0 yellow">General Topics</h2><ul class="panel-hole" id="list-general"><li data-name="Data Lifecycle"><a href="data-lifecycle.html" class="white strong">Data Lifecycle</a><li data-name="Storage"><a href="storage.html">Storage</a><li data-name="Migrations"><a href="migrations.html">Migrations</a><li data-name="Libraries"><a href="libraries.html">Libraries</a><li data-name="Prototype Inheritance Tree"><a href="prototype-tree.html">Prototype Inheritance Tree</a><li data-name="Noise Expressions"><a href="noise-expressions.html">Noise Expressions</a><li data-name="Instrument Mode"><a href="instrument.html">Instrument Mode</a><li data-name="Item Weight"><a href="item-weight.html">Item Weight</a></ul><h2 class="ml8 mt8 mb0 yellow">JSON Docs</h2><ul class="panel-hole" id="list-json"><li data-name="Runtime JSON Format"><a href="json-docs-runtime.html">Runtime JSON Format</a><li data-name="Prototype JSON Format"><a href="json-docs-prototype.html">Prototype JSON Format</a></ul><p><h2 class="ml8 mt8 mb0 yellow"><a class="collapse-link not-selectable" data-view="list-defines" data-collapsed="false"><img src="../static/collapse-symbol.png" class="collapse-icon" style="pointer-events: none;"><img src="../static/expand-symbol.png" class="expand-icon" style="pointer-events: none; display: none;"></a><a href="../defines.html"> Defines</a></h2><ul class="panel-hole" id="list-defines"><li data-name="alert_type"><a href="../defines.html#defines.alert_type">alert_type</a><li data-name="behavior_result"><a href="../defines.html#defines.behavior_result">behavior_result</a><li data-name="build_check_type"><a href="../defines.html#defines.build_check_type">build_check_type</a><li data-name="build_mode"><a href="../defines.html#defines.build_mode">build_mode</a><li data-name="cargo_destination"><a href="../defines.html#defines.cargo_destination">cargo_destination</a><li data-name="chain_signal_state"><a href="../defines.html#defines.chain_signal_state">chain_signal_state</a><li data-name="chunk_generated_status"><a href="../defines.html#defines.chunk_generated_status">chunk_generated_status</a><li data-name="command"><a href="../defines.html#defines.command">command</a><li data-name="compound_command"><a href="../defines.html#defines.compound_command">compound_command</a><li data-name="control_behavior"><a href="../defines.html#defines.control_behavior">control_behavior</a><li data-name="controllers"><a href="../defines.html#defines.controllers">controllers</a><li data-name="deconstruction_item"><a href="../defines.html#defines.deconstruction_item">deconstruction_item</a><li data-name="default_icon_size"><a href="../defines.html#defines.default_icon_size">default_icon_size</a><li data-name="difficulty"><a href="../defines.html#defines.difficulty">difficulty</a><li data-name="direction"><a href="../defines.html#defines.direction">direction</a><li data-name="disconnect_reason"><a href="../defines.html#defines.disconnect_reason">disconnect_reason</a><li data-name="distraction"><a href="../defines.html#defines.distraction">distraction</a><li data-name="entity_status"><a href="../defines.html#defines.entity_status">entity_status</a><li data-name="entity_status_diode"><a href="../defines.html#defines.entity_status_diode">entity_status_diode</a><li data-name="events"><a href="../defines.html#defines.events">events</a><li data-name="flow_precision_index"><a href="../defines.html#defines.flow_precision_index">flow_precision_index</a><li data-name="game_controller_interaction"><a href="../defines.html#defines.game_controller_interaction">game_controller_interaction</a><li data-name="group_state"><a href="../defines.html#defines.group_state">group_state</a><li data-name="gui_type"><a href="../defines.html#defines.gui_type">gui_type</a><li data-name="input_action"><a href="../defines.html#defines.input_action">input_action</a><li data-name="input_method"><a href="../defines.html#defines.input_method">input_method</a><li data-name="inventory"><a href="../defines.html#defines.inventory">inventory</a><li data-name="logistic_member_index"><a href="../defines.html#defines.logistic_member_index">logistic_member_index</a><li data-name="logistic_mode"><a href="../defines.html#defines.logistic_mode">logistic_mode</a><li data-name="logistic_section_type"><a href="../defines.html#defines.logistic_section_type">logistic_section_type</a><li data-name="mouse_button_type"><a href="../defines.html#defines.mouse_button_type">mouse_button_type</a><li data-name="moving_state"><a href="../defines.html#defines.moving_state">moving_state</a><li data-name="print_skip"><a href="../defines.html#defines.print_skip">print_skip</a><li data-name="print_sound"><a href="../defines.html#defines.print_sound">print_sound</a><li data-name="prototypes"><a href="../defines.html#defines.prototypes">prototypes</a><li data-name="rail_connection_direction"><a href="../defines.html#defines.rail_connection_direction">rail_connection_direction</a><li data-name="rail_direction"><a href="../defines.html#defines.rail_direction">rail_direction</a><li data-name="rail_layer"><a href="../defines.html#defines.rail_layer">rail_layer</a><li data-name="relative_gui_position"><a href="../defines.html#defines.relative_gui_position">relative_gui_position</a><li data-name="relative_gui_type"><a href="../defines.html#defines.relative_gui_type">relative_gui_type</a><li data-name="render_mode"><a href="../defines.html#defines.render_mode">render_mode</a><li data-name="rich_text_setting"><a href="../defines.html#defines.rich_text_setting">rich_text_setting</a><li data-name="riding"><a href="../defines.html#defines.riding">riding</a><li data-name="robot_order_type"><a href="../defines.html#defines.robot_order_type">robot_order_type</a><li data-name="rocket_silo_status"><a href="../defines.html#defines.rocket_silo_status">rocket_silo_status</a><li data-name="selection_mode"><a href="../defines.html#defines.selection_mode">selection_mode</a><li data-name="shooting"><a href="../defines.html#defines.shooting">shooting</a><li data-name="signal_state"><a href="../defines.html#defines.signal_state">signal_state</a><li data-name="space_platform_state"><a href="../defines.html#defines.space_platform_state">space_platform_state</a><li data-name="target_type"><a href="../defines.html#defines.target_type">target_type</a><li data-name="train_state"><a href="../defines.html#defines.train_state">train_state</a><li data-name="transport_line"><a href="../defines.html#defines.transport_line">transport_line</a><li data-name="wire_connector_id"><a href="../defines.html#defines.wire_connector_id">wire_connector_id</a><li data-name="wire_origin"><a href="../defines.html#defines.wire_origin">wire_origin</a><li data-name="wire_type"><a href="../defines.html#defines.wire_type">wire_type</a></ul></div></div><div class="docs-sidebar-thin mr8 flex-column" style="margin-top: 20px;"><a id="show-sidebar-button" class="button square-sm ml0">&gt;|</a></div></div></div></div></div><div class="footer"><div class="panel"><div class="panel-inset m0 text-center"> Copyright © Wube Software <span class="separator">|</span><a href="../license.html">License</a><span class="separator">|</span><a href="../static/archive.zip">Download</a><span class="separator">|</span><a href="https://forums.factorio.com/viewforum.php?f=233" target="_blank">Feedback</a></div></div></div></body></html>